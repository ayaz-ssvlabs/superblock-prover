# SP1 Superblock Verification

This project uses [SP1](https://github.com/succinctlabs/sp1) to generate zero-knowledge proofs
for superblock transition verification, ensuring cryptographic validity of blockchain state transitions.

## Requirements

- [Rust](https://rustup.rs/)
- [SP1](https://docs.succinct.xyz/docs/sp1/getting-started/install)

## Running the Project

This project verifies superblock transitions using zero-knowledge proofs. There are 2 main ways to run this project: execute verification directly, or generate a cryptographic proof.

### Build the Program

The program is automatically built through `script/build.rs` when the script is built.

### Execute Superblock Verification

To run the superblock verification without generating a proof:

```sh
cd script
cargo run --release --bin superblock -- --execute
```

This will execute the superblock transition verification and display the results, including:
- Previous and new superblock hashes
- Verification of transition rules (number increment, parent hash matching, Merkle root validation)
- Confirmation of valid state transition

### Generate an SP1 Core Proof

To generate an SP1 [core proof](https://docs.succinct.xyz/docs/sp1/generating-proofs/proof-types#core-default) (STARK) for superblock verification:

```sh
cd script
cargo run --release --bin superblock -- --prove
```

### Generate a Groth16 Proof

To generate a Groth16 proof for superblock verification (ideal for on-chain verification due to constant proof size and fast verification):

```sh
cd script
cargo run --release --bin superblock -- --groth16
```

Note: Groth16 proof generation takes longer than STARK proofs but produces much smaller, constant-size proofs (typically ~200 bytes) with very fast verification suitable for smart contracts.

### Debug Logging

To see detailed internal SP1 processing information, you can use the `--verbose` flag or set the `RUST_LOG` environment variable:

```sh
# Using verbose flag (recommended)
cargo run --release --bin superblock -- --groth16 --verbose

# Using environment variable
RUST_LOG=debug cargo run --release --bin superblock -- --groth16

# Targeted logging for specific components
RUST_LOG="shrink=debug,wrap_bn254=debug" cargo run --release --bin superblock -- --groth16
```

## Superblock Verification Features

This implementation includes:

- **Merkle Root Calculation**: Computes Merkle trees from L2 blocks with deterministic ordering
- **Superblock Hash Validation**: Implements the exact hash calculation logic (Number || Slot || ParentHash || MerkleRoot)
- **Transition Rule Verification**: Ensures valid state transitions between superblocks:
  - Sequential number increment (new = prev + 1)
  - Parent hash matching
  - Slot monotonicity
  - Merkle root correctness
  - Timestamp progression
- **Zero-Knowledge Proofs**: Generates both STARK and Groth16 cryptographic proofs of valid transitions
- **Solidity Compatibility**: Outputs are ABI-encoded for on-chain verification
- **Groth16 Support**: Constant-size proofs (~200 bytes) optimized for on-chain verification

## Data Structures

The verification handles the following superblock structure:
- `number`: Superblock sequence number
- `slot`: Blockchain slot number
- `parent_hash`: Hash of the previous superblock
- `merkle_root`: Root of the L2 blocks Merkle tree
- `l2_blocks`: Array of L2 blocks with cross-chain transactions
- `timestamp`: Block timestamp for monotonicity checks

## Using the Prover Network

We highly recommend using the [Succinct Prover Network](https://docs.succinct.xyz/docs/network/introduction) for any non-trivial programs or benchmarking purposes. For more information, see the [key setup guide](https://docs.succinct.xyz/docs/network/developers/key-setup) to get started.

To get started, copy the example environment file:

```sh
cp .env.example .env
```

Then, set the `SP1_PROVER` environment variable to `network` and set the `NETWORK_PRIVATE_KEY`
environment variable to your whitelisted private key.

For example, to generate a superblock verification proof using the prover network, run one of the following
commands:

```sh
# Generate STARK proof
SP1_PROVER=network NETWORK_PRIVATE_KEY=... cargo run --release --bin superblock -- --prove

# Generate Groth16 proof
SP1_PROVER=network NETWORK_PRIVATE_KEY=... cargo run --release --bin superblock -- --groth16
```

## On-Chain Verification

The Groth16 proofs generated by this system are designed for efficient on-chain verification. SP1 provides Solidity verifier contracts that can validate Groth16 proofs directly on Ethereum and other EVM-compatible chains.

### Solidity Integration

The public values are ABI-encoded and include:
- `prev_superblock_hash`: Hash of the previous superblock (bytes32)
- `new_superblock_hash`: Hash of the new superblock (bytes32)  
- `prev_number`: Previous superblock number (uint64)
- `new_number`: New superblock number (uint64)
- `is_valid_transition`: Whether the transition is valid (bool)

These values can be verified on-chain alongside the Groth16 proof to ensure the superblock transition was computed correctly.
